substitutions:
  _EXERCICIO_K8S_VERSION: 1.0.0
steps:
  - id: "Executando build e subindo imagem para GCR privado"
    name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/webserver-go-greeting:latest'
      - '-t'
      - 'gcr.io/$PROJECT_ID/webserver-go-greeting:${_EXERCICIO_K8S_VERSION}'
      - './3-desafio_go/'
      
  - id: "Instalando o GO ..."
    name: 'gcr.io/cloud-builders/go'
    args: ['install', './greeting/']
    env: ['PROJECT_ROOT=server']
    dir: './3-desafio_go/'

  # - id: "Rodando testes ..."
  #   name: 'gcr.io/cloud-builders/go'
  #   args: ['test', 'server']
  #   env: ['PROJECT_ROOT=server']
  #   dir: './3-desafio_go/'

  # - id: "Executando o build da aplicação."
  #   name: 'gcr.io/cloud-builders/go'
  #   args: ['build', '-o', '$GOPATH/src/greeting/webserver-go-greeting']
  #   env: ['PROJECT_ROOT=server']
  #   dir: './3-desafio_go/'

images:
  - 'gcr.io/$PROJECT_ID/webserver-go-greeting:latest'
  - 'gcr.io/$PROJECT_ID/webserver-go-greeting:${_DESAFIO_CI_VERSION}'
tags: ['fullcycle-exercicio-k8s']